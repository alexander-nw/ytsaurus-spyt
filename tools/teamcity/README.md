# Инструменты для teamcity

## Сборки в Teamcity

Для SPYT определены четыре сборки:

- [Юнит-тесты](https://teamcity.taxi.yandex-team.ru/buildConfiguration/YandexTaxiProjects_DMP_SPYT_PullRequests_PullRequests)
- [E2E-тесты](https://teamcity.taxi.yandex-team.ru/buildConfiguration/YandexTaxiProjects_DMP_SPYT_PullRequests_E2ETests)
- [Сборка проекта в тестинг](https://teamcity.taxi.yandex-team.ru/buildConfiguration/YandexTaxiProjects_DMP_SPYT_Releases_Testing)
- [Релиз проекта](https://teamcity.taxi.yandex-team.ru/buildConfiguration/YandexTaxiProjects_DMP_SPYT_Releases_Testing)

## Базовый образ

Все сборки выполняются на основе базового образа, описанного в Dockerfile.

Если необходимо поменять базовый образ, собираем его из текущей директории и загружаем в registry:

```bash
docker build -t registry.yandex.net/taxi-dmp-spark/spyt-test-base .
docker push registry.yandex.net/taxi-dmp-spark/spyt-test-base
```

По умолчанию все сборки используют таг latest, но этим можно управлять, устанавливая в параметре
`env.SPYT_TEST_IMAGE_TAG` сборки желаемый таг.

Основные скрипты для базового образа -- `entrypoint.sh`, где устанавливаются нужные кеши, формируются команды
для тестов / релизов и так далее. В `cli.py` содержатся вспомогательные команды, которые нужны в ходе сборки.

Note: cli.py также напрямую вызывается из билд-агента (т.е. не в базовом контейнере) для обновления версии
в транке после релиза.

## Тесты

Если по результатам сборки с тестами (юнит- и E2E) в любой поддиректории проекта
оказывается директория test-reports (или несколько таких директорий), то JUnit-репорты
из них будут загружены в TeamCity.

### Юнит-тесты

Сборка с юнит-тестами запускается автоматически на каждый пулл-реквест и на каждое изменение в транке.
Дополнительно юнит-тесты запускаются как шаг в релизной сборке, поэтому если транк красный, покатить релиз
через сборку не получится.

### E2E-тесты

E2E-тесты запускаются автоматически каждые два часа на транке. Также их можно запустить вручную на ветке,
соответсвующей пулл-реквесту, для этого берем id пулл-реквеста и в TeamCity запускаем сборку, в Changes выбрав
ветку `users/robot-stark/taxi/dmp/spark/spark-over-yt/{id_пулл_реквеста}`:

![скриншот](https://jing.yandex-team.ru/files/devsagul/Firefox_Screenshot_2022-09-09T08-58-03.373Z.png)

Сборка ограничена одним одновременным запуском.

В E2E-тестах можно выбирать параметр PUBLISH_MODE и устанавливать cluster или spark-fork в зависимости
от того, какие компоненты нужно протестировать.

## Релизы

Релизы используют тот же самый базовый образ. С точки зрения SPYT любой релиз -- это загрузка артефактов
в YT, Artifactory, etc.

Есть три варианта релизов:

- client
- cluster
- spark-fork

При этом каждый следующий вариант включает в себя предыдущий, т.е. мы можем покатить только client
(на самом деле client это два компонента: client и python-пакет к нему), но если мы запустим выкатку cluster,
то автоматически соберется и выкатится client. В случае spark-fork выкатываются все три компонента.

### Testing

В тестинг можно ехать из транка или из ветки с пулл-реквестом. Релиз в тестинг не запускает предварительные тесты.
В результате будут выкачены версии нескольких компонентов (см. выше), все эти версии будут перечислены
в статусе сборки, если она прошла успешно, например:

![скриншот](https://jing.yandex-team.ru/files/devsagul/Firefox_Screenshot_2022-09-09T09-05-17.782Z.png)

### Stable

Релизная сборка может быть запущена только из транка, предварительно она запускает юнит-тесты.

По результатам релизной сборки (если она прошла успешно), создается пулл-реквест от robot-taxi
с бампом версий обновленных компонентов, который должен автоматически подмерджиться в транк
(i.e. если через какое-то время версия в транке не обновилась -- нужно поискать в логах сборки
создание PR и устранить причину, по которой он не вмердживается).

Релизная версия также пишет в статус версии обновленных компонентов.
